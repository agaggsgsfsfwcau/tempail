<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Temp Mail</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    body {
      font-family: system-ui, sans-serif;
    }
    .fade-in {
      animation: fadeIn 0.4s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .hover-animate:hover {
      transform: scale(1.03);
      transition: transform 0.2s;
    }
    /* Improved scrollbar for inbox */
    #inbox::-webkit-scrollbar {
      width: 6px;
    }
    #inbox::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    #inbox::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
    }
    /* Better message content styling */
    #messageContent pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      padding: 0.5rem;
      background: #f8f8f8;
      border-radius: 0.25rem;
    }
    #messageContent img {
      max-width: 100%;
      height: auto;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-900 fade-in">
  <div class="max-w-3xl mx-auto my-6 px-4">
    <div class="bg-white rounded-xl shadow-xl overflow-hidden">
      <!-- Header -->
      <header class="p-6 border-b border-gray-200">
        <div class="flex justify-between items-center">
          <h1 class="text-3xl font-bold flex items-center gap-2 text-blue-600">
            <span class="material-icons">mail_outline</span> Temp Mail
          </h1>
        </div>
      </header>

      <!-- Main -->
      <main class="p-6 space-y-6">
        <!-- Email Generator -->
        <section>
          <input id="customUsername" type="text" placeholder="Custom email name (optional)" 
                 class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 transition-all" 
                 maxlength="32" />
          <div class="flex flex-col md:flex-row items-center gap-3 mt-4">
            <input id="emailDisplay" class="w-full p-3 border rounded-lg bg-gray-50" readonly />
            <div class="flex gap-2 w-full md:w-auto">
              <button onclick="generateEmail()" class="hover-animate bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg flex items-center gap-1">
                <span class="material-icons">autorenew</span> <span>Generate</span>
              </button>
              <button onclick="refreshInbox()" class="hover-animate bg-green-600 hover:bg-green-700 text-white p-3 rounded-lg flex items-center gap-1">
                <span class="material-icons">refresh</span> <span>Refresh</span>
              </button>
              <button onclick="copyEmail()" class="hover-animate bg-purple-600 hover:bg-purple-700 text-white p-3 rounded-lg flex items-center gap-1">
                <span class="material-icons">content_copy</span> <span>Copy</span>
              </button>
            </div>
          </div>
        </section>

        <!-- Inbox and Message -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Inbox -->
          <div class="bg-gray-50 rounded-lg p-4 shadow-inner fade-in">
            <div class="flex justify-between items-center mb-3">
              <h2 class="text-lg font-semibold">Inbox</h2>
              <div id="loader" class="text-gray-500 text-sm flex items-center gap-1">
                <span class="material-icons animate-spin hidden">refresh</span>
                <span></span>
              </div>
            </div>
            <ul id="inbox" class="space-y-2 max-h-96 overflow-y-auto text-sm"></ul>
          </div>

          <!-- Message Body -->
          <div id="messageBody" class="bg-gray-50 rounded-lg p-4 shadow-inner hidden fade-in">
            <div class="flex justify-between items-center mb-3">
              <h2 class="text-lg font-semibold">Message</h2>
              <button onclick="closeMessageView()" class="bg-gray-200 p-2 rounded hover:bg-gray-300">
                <span class="material-icons">close</span>
              </button>
            </div>
            <div class="mb-3 space-y-1 text-sm">
              <div><strong>From:</strong> <span id="msgFrom" class="text-blue-600"></span></div>
              <div><strong>Subject:</strong> <span id="msgSubject"></span></div>
              <div><strong>Time:</strong> <span id="msgTime" class="text-gray-500"></span></div>
            </div>
            <hr class="my-3 border-gray-300">
            <div id="messageContent" class="text-sm overflow-auto max-h-72"></div>
            <div class="mt-4 flex flex-wrap gap-2">
              <button onclick="deleteCurrentMessage()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded flex items-center gap-1">
                <span class="material-icons text-sm">delete</span> <span>Delete</span>
              </button>
              <button onclick="downloadTxt()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded flex items-center gap-1">
                <span class="material-icons text-sm">download</span> <span>Download</span>
              </button>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // Constants
    const API_BASE = "https://email.vwh.sh/api";
    const DOMAINS = ["vwh.sh"]; // Can be extended with more domains if available
    const AUTO_REFRESH_INTERVAL = 15000; // 15 seconds
    
    // DOM Elements
    const DOM = {
      emailInput: document.getElementById('emailDisplay'),
      customUsername: document.getElementById('customUsername'),
      inboxList: document.getElementById('inbox'),
      loader: document.getElementById('loader'),
      loaderIcon: document.querySelector('#loader .material-icons'),
      messageBody: document.getElementById('messageBody'),
      msgFrom: document.getElementById('msgFrom'),
      msgSubject: document.getElementById('msgSubject'),
      msgTime: document.getElementById('msgTime'),
      messageContent: document.getElementById('messageContent'),
    };

    // Application State
    const state = {
      currentEmail: localStorage.getItem('temp_email') || '',
      refreshInterval: null,
      currentMessage: null,
      messages: []
    };

    // Utility Functions
    const generateRandomAlias = (length = 10) => {
      const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
      const randomValues = new Uint32Array(length);
      window.crypto.getRandomValues(randomValues);
      return Array.from(randomValues, x => chars[x % chars.length]).join('');
    };

    const sanitizeInput = (str) => str.toLowerCase().replace(/[^a-z0-9]/g, '').substring(0, 32);

    const showLoader = (text = 'Loading...') => {
      DOM.loaderIcon.classList.remove('hidden');
      DOM.loader.lastChild.textContent = text;
    };

    const hideLoader = () => {
      DOM.loaderIcon.classList.add('hidden');
      DOM.loader.lastChild.textContent = '';
    };

    const renderEmptyInbox = () => {
      DOM.inboxList.innerHTML = `<li class='text-gray-500 p-3 text-center'>No messages found</li>`;
    };

    const getRandomDomain = () => DOMAINS[Math.floor(Math.random() * DOMAINS.length)];

    // Core Functions
    async function generateEmail() {
      clearInterval(state.refreshInterval);
      DOM.messageBody.classList.add('hidden');
      DOM.inboxList.innerHTML = '';
      showLoader('Generating email...');
      
      try {
        const username = DOM.customUsername.value.trim() || generateRandomAlias();
        const cleanUsername = sanitizeInput(username);
        const domain = getRandomDomain();
        state.currentEmail = `${cleanUsername}@${domain}`;
        DOM.emailInput.value = state.currentEmail;
        localStorage.setItem('temp_email', state.currentEmail);
        await refreshInbox();
        startAutoRefresh();
      } catch (error) {
        console.error('Error generating email:', error);
        hideLoader();
        alert(`Error: ${error.message || 'Failed to generate email'}`);
      }
    }

    function startAutoRefresh() {
      clearInterval(state.refreshInterval);
      state.refreshInterval = setInterval(refreshInbox, AUTO_REFRESH_INTERVAL);
    }

    async function refreshInbox() {
      if (!state.currentEmail) return;
      showLoader('Refreshing inbox...');
      
      try {
        const response = await fetch(`${API_BASE}/email/${encodeURIComponent(state.currentEmail)}`);
        if (!response.ok) throw new Error(response.status === 404 ? 'Email not found' : 'Failed to fetch messages');
        
        const messages = await response.json();
        state.messages = messages;
        hideLoader();
        
        if (!messages.length) {
          renderEmptyInbox();
          return;
        }
        
        DOM.inboxList.innerHTML = messages.map(msg => {
          const from = msg.fromAddress || 'Unknown sender';
          const subject = msg.subject || '(No subject)';
          const date = new Date(msg.createdAt).toLocaleString();
          
          return `
            <li class="hover-animate p-3 bg-white rounded border cursor-pointer hover:bg-blue-50"
                onclick="readMessage('${msg.id}')">
              <div class="font-semibold truncate" title="${from}">${from}</div>
              <div class="text-gray-700 truncate" title="${subject}">${subject}</div>
              <div class="text-xs text-gray-400">${date}</div>
            </li>
          `;
        }).join('');
      } catch (error) {
        console.error('Error refreshing inbox:', error);
        hideLoader();
        DOM.inboxList.innerHTML = `<li class='text-red-500 p-3'>${error.message || 'Failed to load messages'}</li>`;
      }
    }

    async function readMessage(id) {
      try {
        showLoader('Loading message...');
        const response = await fetch(`${API_BASE}/inbox/${id}`);
        if (!response.ok) throw new Error('Failed to fetch message');
        
        const message = await response.json();
        state.currentMessage = { id, ...message };
        
        // Update message view
        DOM.msgFrom.textContent = message.fromAddress || 'Unknown sender';
        DOM.msgSubject.textContent = message.subject || '(No subject)';
        DOM.msgTime.textContent = new Date(message.createdAt).toLocaleString();
        DOM.messageContent.innerHTML = '';
        
        // Safely render message content
        if (message.htmlContent) {
          const cleanHtml = message.htmlContent
            .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
            .replace(/on\w+="[^"]*"/g, '')
            .replace(/<style\b[^>]*>[\s\S]*?<\/style>/gi, '');
          
          // Create a sandboxed iframe for safer HTML rendering
          const iframe = document.createElement('iframe');
          iframe.sandbox = 'allow-same-origin';
          iframe.style.width = '100%';
          iframe.style.height = '100%';
          iframe.style.border = 'none';
          iframe.srcdoc = cleanHtml;
          
          DOM.messageContent.appendChild(iframe);
        } else if (message.textContent) {
          const pre = document.createElement('pre');
          pre.className = 'whitespace-pre-wrap p-2 bg-gray-100 rounded';
          pre.textContent = message.textContent;
          DOM.messageContent.appendChild(pre);
        } else {
          DOM.messageContent.textContent = '(No content)';
        }
        
        DOM.messageBody.classList.remove('hidden');
        hideLoader();
      } catch (error) {
        console.error('Error reading message:', error);
        hideLoader();
        alert(`Error: ${error.message || 'Failed to load message'}`);
      }
    }

    function closeMessageView() {
      DOM.messageBody.classList.add('hidden');
      state.currentMessage = null;
    }

    async function deleteCurrentMessage() {
      if (!state.currentMessage?.id) return;
      if (!confirm('Are you sure you want to delete this message?')) return;
      
      try {
        showLoader('Deleting...');
        const response = await fetch(`${API_BASE}/delete/${state.currentMessage.id}`, {
          method: 'DELETE'
        });
        
        if (!response.ok) throw new Error('Failed to delete message');
        const result = await response.text();
        if (result !== 'true') throw new Error('Failed to delete message');
        
        closeMessageView();
        await refreshInbox();
      } catch (error) {
        console.error('Error deleting message:', error);
        alert(`Error: ${error.message}`);
      } finally {
        hideLoader();
      }
    }

    function downloadTxt() {
      if (!state.currentMessage) return;
      
      const { subject, fromAddress, textContent, createdAt } = state.currentMessage;
      const filename = `${(subject || 'message').replace(/[^a-z0-9]/gi, '_').toLowerCase()}.txt`;
      const content = [
        `From: ${fromAddress || 'Unknown'}`,
        `To: ${state.currentEmail}`,
        `Subject: ${subject || '(No subject)'}`,
        `Time: ${new Date(createdAt).toLocaleString()}`,
        '',
        textContent || '(No content)'
      ].join('\n');
      
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    async function copyEmail() {
      if (!state.currentEmail) return;
      
      try {
        await navigator.clipboard.writeText(state.currentEmail);
        const btn = document.querySelector('button[onclick="copyEmail()"]');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<span class="material-icons">check</span> <span>Copied!</span>';
        setTimeout(() => btn.innerHTML = originalHTML, 2000);
      } catch (error) {
        console.error('Error copying email:', error);
        alert('Failed to copy email to clipboard');
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      if (state.currentEmail) {
        DOM.emailInput.value = state.currentEmail;
        refreshInbox();
        startAutoRefresh();
      }
      
      // Add input event for custom username
      DOM.customUsername.addEventListener('input', (e) => {
        e.target.value = sanitizeInput(e.target.value);
      });
    });

    // Cleanup
    window.addEventListener('beforeunload', () => {
      clearInterval(state.refreshInterval);
    });
  </script>
</body>
</html>
